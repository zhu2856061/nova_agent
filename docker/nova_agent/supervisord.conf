# /app/supervisord.conf

[supervisord]
nodaemon=true                    # Docker 前台必须
logfile=/tmp/supervisord.log      # 改！Ubuntu 默认没有 /var/log，改到 /tmp 避免权限问题
pidfile=/tmp/supervisord.pid
user=root

# ==================== 程序定义 ====================

[program:caddy]
command=caddy run --config /etc/caddy/Caddyfile --adapter caddyfile
autorestart=true
startsecs=5                      # 增加到5秒，避免启动太快判失败
autostart=true                   # 显式添加，确保启动
user=root                        # 关键！加这行，避免 Nginx 以 nobody 启动失败
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
priority=100
stopsignal=QUIT                  # 优雅停止（Nginx 推荐）

[program:reflex-backend]
directory=/app/backend
command=reflex run --env prod --backend-only --backend-port 8000 --loglevel info
autorestart=true
startsecs=10
autostart=true
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
environment=API_URL="http://localhost:2022"
priority=200

[program:agent-engine]
directory=/app/engine
command=uvicorn nova.main:app --host 0.0.0.0 --port 2021
autorestart=true
startsecs=10
autostart=true
stdout_logfile=/dev/stdout
stderr_logfile=/dev/stderr
environment=CONFIG_PATH="/app/engine/config.yaml"
priority=300