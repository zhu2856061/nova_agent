# Caddyfile —— 完全遵循 Reflex 官方最新写法
:{$PORT}

encode gzip zstd

# 把 Reflex 所有需要实时通信的路径全部代理到内部 8000
@reflex_backend {
    path /_event/* /ping /_upload /_upload/*
    # Reflex 最新版还可能用到下面这几个（保险起见全加上）
    path /api/* /_reflex/*
}
handle @reflex_backend {
    reverse_proxy localhost:8000
}

# 静态前端（SPA）
root * /srv

route {
    # 强制所有 .js 文件返回正确 MIME（正则匹配结尾 .js）
    @js_files path_regexp ^(.*\.js)$
    header @js_files Content-Type application/javascript

    # 额外覆盖所有 _next 路径（Reflex/Next.js 模块脚本都在这里）
    @next_files path /_next/*
    header @next_files Content-Type application/javascript

    # 可选：如果有 .mjs 文件（现代 JS 模块）
    @mjs_files path_regexp ^(.*\.mjs)$
    header @mjs_files Content-Type application/javascript

    # SPA 路由：所有非文件路径都 fallback 到 index.html
    try_files {path} {path}/ /index.html

    # 静态文件服务
    file_server
}